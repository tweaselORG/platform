---
import { e, client } from '../../../lib/db';
import { isValidProceedingState } from '../../../lib/typeguard';
import NeedsInitialAnalysis from '../../../components/ProceedingLandingPage/NeedsInitialAnalysis.astro';
import InitialAnalysisFoundNothing from '../../../components/ProceedingLandingPage/InitialAnalysisFoundNothing.astro';
import AwaitingControllerResponse from '../../../components/ProceedingLandingPage/AwaitingControllerResponse.astro';
import AwaitingControllerNotice from '../../../components/ProceedingLandingPage/AwaitingControllerNotice.astro';

const { token } = Astro.params;
if (!token) throw new Error('This should never happen.');

const proceeding = await e
    .select(e.Proceeding, () => ({
        state: true,

        filter_single: { token },
    }))
    .assert_single()
    .run(client);

if (!proceeding) return new Response('Invalid token.', { status: 403 });

const state = proceeding.state;
if (!isValidProceedingState(state)) throw new Error('This should never happen.');
---

{
    state === 'needsInitialAnalysis' ? (
        <NeedsInitialAnalysis />
    ) : state === 'initialAnalysisFoundNothing' ? (
        <InitialAnalysisFoundNothing token={token} />
    ) : state === 'awaitingControllerNotice' ? (
        <AwaitingControllerNotice token={token} />
    ) : state === 'awaitingControllerResponse' ? (
        <AwaitingControllerResponse token={token} />
    ) : (
        ''
    )
}
